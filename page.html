<html>
<head>

  <style>
    body {
        background-color: #222;
        font-family: monospace;
        font-size: 12px;
        color: lightgrey;
        font-weight: 400;
        /* text-decoration: none solid rgb(68, 68, 68); */
        text-decoration: none solid;
        font-style: normal;
        font-variant: normal;
        text-transform: none;
        white-space: pre;
    }


/* TODO: responsive text sizing for high-dpi displays (laptops & mobile devices) */
/*
@media  only screen and (-webkit-min-device-pixel-ratio: 2),
    only screen and (-o-min-device-pixel-ratio: 20/10),
    only screen and (min-resolution: 192dpi)
    {
        body{font-size: 200%}
    }
@media  only screen and (-webkit-min-device-pixel-ratio: 1.3),
    only screen and (-o-min-device-pixel-ratio: 13/10),
    only screen and (min-resolution: 120dpi)
    {
        body{font-size: 150%}
    }
*/
    a {
        color: #B4E8EF;
        text-decoration: none;
    }

    .expired {
        color: darkgrey;
    }
    .late_show {
        color: #4c9bd8;
    }

    .title {
        color:white;
    }

    .theater {
        color:lightgrey;
    }
    </style>

<script>

var theater_data  = {};
var request_queue = {};
var str_output    = "";
var last_theater  = "";

var p_zip        = "PARAM_ZIP_CODE"
var p_num_result = "PARAM_NUM_RESULTS"
var p_code       = "PARAM_THEATER_CODE"
var p_date       = "PARAM_DATE"

var date_req_max = 2; // Number of days into the future to request
var wait_time    = 100; // in msec

// GLOBALS
var url_theaters_by_zip   = "https://flixster.com/api/backstage/autocomplete/v2?searchText=" + p_zip + "&pageSize=" + p_num_result + "&page=1"
var url_theater_dates     = "https://flixster.com/api/backstage/theaters/v2/" + p_code + "/display-dates"
// PARAM_DATE: 2019-09-17
var url_theater_showtimes = "https://flixster.com/api/backstage/theaters/v2/" + p_code + "/showtime-groupings?startDisplayDate=" + p_date

// https://code-maven.com/ajax-request-for-json-data
// https://stackoverflow.com/questions/8582663/pass-arguments-into-ajax-onreadystatechange-callback
function ajax_get(url, callback, param) {

    var xmlhttp = new XMLHttpRequest();

    xmlhttp.onreadystatechange = (function(xmlhttp, param) {

        return function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

                // console.log('responseText:' + xmlhttp.responseText);

                try {
                    var data = JSON.parse(xmlhttp.responseText);
                } catch(err) {
                    console.log(err.message + " in " + xmlhttp.responseText);
                    return;
                }

                callback(data, param);
            }
        }
    })(xmlhttp, param);

    xmlhttp.open("GET", url, true);
    xmlhttp.send();
}


// TODO: use a queue instead
// https://stackoverflow.com/questions/951021/what-is-the-javascript-version-of-sleep
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}


// Returns MM/DD/YYYY
function format_date(date) {
  return date.getMonth()+1 + "/" + date.getDate() + "/" + date.getFullYear()
}

// Returns H:MM A/PM
function format_time(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0'+minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

// Max of pad 100 Left
function pad_l(str,padlen) {

    if (padlen > 100) padlen = 100;
    return ((Array(100).join(' ') + str).slice(padlen * -1));
}


// Max of pad 100 Right
function pad_r(str,padlen) {

    if (padlen > 100) padlen = 100;
    return ((str + (Array(100).join(' '))).substring(0, padlen));
}


// Resets and clears the theater data
//
function reset_theater_info()
{
    // Reset theater data
    theater_data = {};

    // Reset queue
    request_queue = {};
    request_queue['theater_id'] = [];
    request_queue['req_date']   = [];

    str_output = "";
    document.getElementById("output").innerHTML = str_output;
}

function output_append(str_add) {
    str_output = str_output + str_add;
    document.getElementById("output").innerHTML = str_output;
}


function get_date_relative_to_today(date_offset) {

    var tdate = new Date();
    tdate.setDate(tdate.getDate() + date_offset);

    var dd = String(tdate.getDate()).padStart(2, '0');
    var mm = String(tdate.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yyyy = tdate.getFullYear();

    tdate = yyyy + '-' + mm + '-' + dd;
    return (tdate);
}


// Query reponse dispatcher
function handle_response(data) {

    // Handle Find by Zip response
    // Handle Theater Dates response
    // Handle Theater Showtimes response
}



function request_theaters_by_zip(zip_code, num_results) {

    var req_url = url_theaters_by_zip;

    zip_code = zip_code.replace(/[^0-9]+/g, '');  // filter out non-numeric values
    num_results = num_results.replace(/[^0-9]+/g, '');  // filter out non-numeric values
    req_url = req_url.replace(p_zip, zip_code);
    req_url = req_url.replace(p_num_result, num_results);

    // console.log (zip_code);
    // console.log (num_results);
    // console.log (req_url);
    output_append("Requesting for zip: " + zip_code);

    ajax_get(req_url, handle_theaters_by_zip, '');
}

// [
//   {
//     "id": "qA9uOxfpjtlOiNd",
//     "name": "Central Cinema",
//     "link": "https:\/\/www.fandango.com\/central-cinema-AAVPX\/theater-page"
//   },
// ...


// Request a list of nearby theaters
function handle_theaters_by_zip(response, param) {

    // Update glboal var storing theater list
    reset_theater_info();

    // Copy the JSON theater data into a global var
    theater_data = response;

    // Query each theater
    for (var i=0; i < response.length; i++) {
        if ( response[i].hasOwnProperty('id') ) {
            // Create theater entry
//            console.log( "Theater " + i + ": " + theater_data[i].name + " (" + theater_data[i].id + ")" );

            // request_theater_dates(theater_data[i].id);

            // Request multiple dates per theather
            for (var date_inc=0; date_inc < date_req_max; date_inc++) {
                request_queue['theater_id'].push(theater_data[i].id);
                request_queue['req_date'].push(get_date_relative_to_today(date_inc));
            }
        }
    }

    // Start the request process
    request_theater_showtimes_next();
}



function request_theater_dates(theater_code) {

    var req_url = url_theater_dates;
    theater_code = theater_code.replace(/[\W_]+/g,'');   // filter out non-alphanumeric
    req_url = req_url.replace(p_code, theater_code);

//    console.log (theater_code);
//    console.log (req_url);

    ajax_get(req_url, handle_theater_dates, theater_code );
}


// {
//   "data": {
//     "displayDates": [
//       "2019-09-17",
//       "2019-09-18",
//       "2019-09-19"
//     ]
//   }
// }

// DISABLED: TODO: DELETE ME
// Request a list of nearby theaters
function handle_theater_dates(response, theater_code) {

    var date_count = 0;
    if ( response.hasOwnProperty('data') ) {
        if ( response.data.hasOwnProperty('displayDates') ) {
            response.data.displayDates.forEach(function (dv) {

                // Limit max number of date requests
                if (date_count < date_req_max) {
                    date_count++;
//                    console.log( "Theater: " + theater_code + " @ " + dv );
                    request_theater_showtimes( theater_code, dv );
                    sleep(wait_time);
                }
            });
        }
    }
}

// Issue next request for theater data
function request_theater_showtimes_next() {

    if ((request_queue['theater_id'].length > 0) &&
        (request_queue['req_date'].length > 0)) {

        sleep(wait_time);
        request_theater_showtimes( request_queue['theater_id'].shift(),
                                   request_queue['req_date'].shift() );
    }
}


function request_theater_showtimes(theater_code, req_date) {

    var req_url = url_theater_showtimes;

    theater_code = theater_code.replace(/[\W_]+/g,'');   // filter out non-alphanumeric
    req_date     = req_date.replace(/[^0-9\-]+/g,''); // filter out non-dates

    req_url = req_url.replace(p_code, theater_code);
    req_url = req_url.replace(p_date, req_date);

//    console.log (theater_code);
//    console.log (req_date);
//    console.log (req_url);

    ajax_get(req_url, handle_theater_showtimes, theater_code );
}


// {
//   "displayDate": "2019-09-17",
//   "movieIds": [
//     {
//       "idProvider": "fandangoApi",
         // "value": "qA9uOxfpjtlOiNd"


function get_theater_object(response, theater_code) {

    var theater_obj;


    // Compare value key against all stored theater ID entries
    for (var t=0; t < theater_data.length; t++) {

        if ( theater_data[t].hasOwnProperty('id') ) {

//            console.log ("Checking ... " + theater_code + " vs " + theater_data[t].id);

            // Found a match? Set the local theater id to it
            if ( theater_data[t].id == theater_code ) {

                theater_obj = theater_data[t];
//                console.log ("Found match " + theater_obj.id);

                return(theater_obj);
            }
        }
    }


    // No match found, return empty object
    return (null);
}


// Example output:
// theater1   show1     date1     showtimes1
//            show2     date1     showtimes1
//                                showtimes2
// theater2   show1     date1     showtimes1
//            show2     date1     showtimes1


function parse_showtimes(response, theater_obj) {

//    if ( ! theater_obj.hasOwnProperty('titles') )
//        theater_obj.titles = {};

    // Theater name
    console.log( "\n\nTheater " +": " + theater_obj.name + " (" + theater_obj.id + ")" );

    // Try to not repeat theater name
    if (theater_obj.name != last_theater)
        output_append( "\n\n<span class=\"theater\">" + "Theater " +": " + theater_obj.name + "\n" + "</span>");
    else
        output_append( pad_l(". . . . . .", 15) + pad_l(". . . . . .", 41) + "\n");
    last_theater = theater_obj.name;

    response.movies.forEach(function (m) {

        // Render Title
        console.log("  >> " + m.title);

        m.movieVariants.forEach(function (mv) {

            var agcount = 0;
            mv.amenityGroups.forEach(function (ag) {

                agcount++;
                // Only print Title on first amenity group, otherwise padded blank spaces
                if (agcount == 1)
                    output_append( "<span class=\"title\">" + pad_r("  * " + m.title, 45) + "</span>");
                else
                    output_append( pad_r(" ", 45) );

                var scount = 0;
                ag.showtimes.forEach(function (showtime) {

                    // TODO: move to function showtime_render()

                    var href = "";
                    var show_class = "";

                    try { href = showtime.links[0].href; }
                        catch(err) { }; // console.log(err.message); }

                    var show_date = new Date(showtime.dateTime.local);
                    var str_date = format_date(show_date);
                    var str_time = format_time(show_date);

                    if (showtime.expired == true)
                        show_class = "expired";
                    else if (show_date.getHours() > 18)
                        show_class = "late_show";

                    scount++;
                    // display show time for first entry only
                    if (scount == 1)
                        output_append( pad_r(str_date + " : ", 13) );

                    output_append("<a class=\"" + show_class + "\" href=" + href + ">" + pad_l(str_time, 10) + "</a>");

                    // console.log("     * " + str_date + " - " + str_time + "  " + href + " " );
                    console.log("     * " + str_date + " - " + str_time );

                });
                // Closing line break
                output_append("\n");
            });
        });
    });

//    // Closing line break
//    output_append("\n");


//    console.log (theater_obj);
    // Issue next request in queue if present
    request_theater_showtimes_next();
}



// Request a list of nearby theaters
function handle_theater_showtimes(response, theater_code) {

    var theater_obj = get_theater_object(response, theater_code);

    // If a matching theater was found, copy the movie showtime data
    if (theater_obj)
        parse_showtimes(response, theater_obj);
}



// -> request_theaters_by_zip
//    -> handle_theaters_by_zip
//       -> request_theater_showtimes_next
//          ^  -> request_theater_showtimes (param: theater_id)
//          ^    -> handle_theater_showtimes  -> +
//          |                                    |
//          +---<-<-<---------loop-------<-<-<---+

// DISABLED:      -> request_theater_dates (param: theater_id)
// DISABLED:         -> handle_theater_dates



function start_request() {

    request_theaters_by_zip("98122", "5");
}

window.onload = function () { start_request(); }


//var response='{"data":{"displayDates":["2019-09-18","2019-09-19","2019-09-20","2019-09-21","2019-09-22","2019-09-23","2019-09-24","2019-09-25","2019-09-26","2019-09-27","2019-09-28","2019-09-29","2019-09-30","2019-10-01","2019-10-02","2019-10-03","2019-10-06","2019-10-10","2019-10-13","2019-10-27","2019-10-28","2019-10-30","2019-11-14","2019-11-15","2019-11-16","2019-11-17","2019-11-18","2019-11-19","2019-11-20","2019-11-21","2019-12-16","2019-12-18"]}}';
 //handle_theater_dates(JSON.parse(response), 'kO9fdJfqBiJgu9o');


// window.onload = function () {
//     document.getElementById("output").innerHTML = pad_r("  * Ferris Bueller's Day Off (1986)", 45) + "----"
// }

</script>

</head>

<body><div id="output">Loading...</div></body>

<html>


